<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Offline Manga Extractor PWA">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; worker-src 'self' blob:; img-src 'self' blob: data:;">

    <title>Manga Extractor</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        :root {
            /* Light Theme */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --panel-bg: #f8fafc;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --modal-bg: rgba(255, 255, 255, 0.98);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border: #334155;
            --panel-bg: #0f172a;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --modal-bg: rgba(15, 23, 42, 0.98);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed from center for mobile scrolling */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            padding-top: 40px;
        }

        /* --- Mobile Optimized Card --- */
        .container { width: 100%; max-width: 600px; margin-bottom: 40px; }
        
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 2rem;
            position: relative;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        /* Header */
        .header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem;
        }
        
        h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }
        .badge {
            font-size: 0.65rem; color: var(--primary); background: rgba(79, 70, 229, 0.1);
            padding: 4px 8px; border-radius: 6px; font-weight: 700; vertical-align: middle;
            margin-left: 8px; border: 1px solid rgba(79, 70, 229, 0.2);
        }
        .subtitle { color: var(--text-sub); font-size: 0.9rem; margin-top: 0.5rem; line-height: 1.4; }

        /* Actions */
        .header-actions { display: flex; gap: 8px; align-items: center; }
        
        .icon-btn {
            background: var(--panel-bg); border: 1px solid var(--border);
            color: var(--text-main); cursor: pointer; width: 40px; height: 40px;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        
        .install-btn {
            background: var(--primary); color: white; border: none; 
            padding: 0 16px; height: 40px; font-size: 0.85rem; font-weight: 600;
            border-radius: 10px; display: flex; align-items: center;
        }

        /* --- Controls --- */
        .controls-grid {
            display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1.5rem;
        }

        .control-panel {
            background: var(--panel-bg); padding: 1rem; border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .control-label {
            display: block; font-size: 0.7rem; font-weight: 700; 
            text-transform: uppercase; color: var(--text-sub); margin-bottom: 0.75rem;
        }

        /* Slider */
        .range-row { display: flex; align-items: center; gap: 15px; }
        input[type=range] { flex: 1; height: 4px; border-radius: 2px; background: var(--border); appearance: none; }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .range-value { font-weight: 700; color: var(--primary); min-width: 45px; text-align: right; }

        /* Toggles */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .toggle-text { font-size: 0.9rem; font-weight: 500; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border); transition: .3s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Drop Zone */
        .drop-zone {
            margin-top: 1.5rem; border: 2px dashed var(--border); border-radius: 16px;
            padding: 2.5rem 1.5rem; text-align: center; cursor: pointer;
            background: var(--panel-bg); transition: 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .drop-zone:active { border-color: var(--primary); background: rgba(79, 70, 229, 0.05); transform: scale(0.98); }
        .icon-box {
            width: 56px; height: 56px; background: var(--card-bg); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 1rem; color: var(--primary); box-shadow: var(--shadow);
        }
        
        /* Progress & Buttons */
        .progress-container { margin-top: 1.5rem; display: none; }
        .progress-track { width: 100%; height: 10px; background: var(--border); border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; }

        .btn-group { display: flex; gap: 10px; margin-top: 1.5rem; display: none; }
        .btn {
            flex: 1; padding: 0.9rem; border: none; border-radius: 12px;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); }
        .btn-danger { background: #fee2e2; color: #ef4444; flex: 0.4; }
        [data-theme="dark"] .btn-danger { background: #451a1a; color: #fca5a5; }

        /* Gallery */
        .gallery-area { margin-top: 2rem; display: none; }
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px; max-height: 250px; overflow-y: auto;
        }
        .gallery-item {
            aspect-ratio: 1/1.4; background: var(--border); border-radius: 6px;
            overflow: hidden; position: relative;
        }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg); backdrop-filter: blur(5px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal img { max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-close {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            background: var(--border); border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; font-size: 24px; color: var(--text-main); cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-row">
            <div>
                <h1>Extractor <span class="badge">PRO</span></h1>
                <p class="subtitle">Secure MHTML Image Extractor</p>
            </div>
            <div class="header-actions">
                <button id="install-btn" class="install-btn hidden">Install</button>
                <button id="theme-toggle" class="icon-btn">
                    <svg id="moon-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="sun-icon" class="hidden" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </div>

        <div class="controls-grid">
            <div class="control-panel">
                <span class="control-label">Filter Small Images</span>
                <div class="range-row">
                    <input type="range" id="size-filter" min="0" max="200" value="40" step="5">
                    <span class="range-value"><span id="size-val">40</span><small>KB</small></span>
                </div>
            </div>

            <div class="control-panel">
                <span class="control-label">Options</span>
                <div class="toggle-row">
                    <span class="toggle-text">Reverse Order</span>
                    <label class="switch"><input type="checkbox" id="reverse-sort"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-text">Exclude GIFs</span>
                    <label class="switch"><input type="checkbox" id="no-gifs"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-text">Save as .CBZ</span>
                    <label class="switch"><input type="checkbox" id="cbz-ext" checked><span class="slider"></span></label>
                </div>
            </div>
        </div>

        <div id="drop-zone" class="drop-zone">
            <input type="file" id="file-input" accept=".mhtml,.mht" multiple style="display:none">
            <div class="icon-box">
                <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            </div>
            <div style="font-weight:600; margin-bottom:4px;">Select MHTML File</div>
            <div style="font-size:0.8rem; color:var(--text-sub);">Tap to upload</div>
        </div>

        <div id="progress-area" class="progress-container">
            <div class="progress-info">
                <span id="status-text">Processing...</span>
                <span id="percent-text">0%</span>
            </div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
        </div>

        <div id="gallery-area" class="gallery-area">
            <div class="control-label">Preview</div>
            <div id="gallery-grid" class="gallery-grid"></div>
        </div>

        <div id="action-area" class="btn-group">
            <button id="reset-btn" class="btn btn-danger">Reset</button>
            <button id="download-btn" class="btn btn-primary">Download</button>
        </div>
    </div>
</div>

<div id="img-modal" class="modal">
    <div class="modal-close">&times;</div>
    <img id="modal-img" src="">
</div>

<script id="worker-code" type="javascript/worker">
    self.onmessage = async function(e) {
        const { files, config } = e.data;
        const processedImages = [];
        const totalFiles = files.length;
        let baseName = "Manga_Export";

        try {
            if (totalFiles > 0) baseName = files[0].name.replace(/\.(mhtml|mht)$/i, "").trim();

            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                self.postMessage({ type: 'progress', text: `Scanning...`, percent: (i / totalFiles) * 70 });
                
                try {
                    const content = await file.text();
                    const folderPrefix = totalFiles > 1 ? file.name.replace(/\.(mhtml|mht)$/i, "").trim() + "/" : "";
                    let result = parseMHTML(content, config);
                    
                    const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
                    result.images.sort((a, b) => collator.compare(a.name, b.name));
                    if (config.reverse) result.images.reverse();

                    result.images.forEach((img, idx) => {
                        const seqName = String(idx + 1).padStart(3, '0') + "." + img.ext;
                        img.zipName = folderPrefix + seqName;
                        processedImages.push(img);
                    });
                } catch (readErr) { console.error(readErr); }
            }

            self.postMessage({ type: 'progress', text: `Compressing...`, percent: 90 });

            if (processedImages.length === 0) {
                self.postMessage({ type: 'error', message: "No images found or files too large." });
                return;
            }

            const zipBlob = createZip(processedImages);
            const preview = processedImages.slice(0, 15).map(img => ({
                blob: new Blob([img.data], {type: "image/"+(img.ext === 'jpg' ? 'jpeg' : img.ext)})
            }));

            self.postMessage({ type: 'done', zipBlob, preview, count: processedImages.length, suggestedName: baseName });

        } catch (err) { self.postMessage({ type: 'error', message: err.message }); }
    };

    function parseMHTML(content, config) {
        let boundary = null;
        const boundaryMatch = content.match(/boundary="?([^";\s]+)"?/i);
        if (boundaryMatch) boundary = "--" + boundaryMatch[1];
        else {
            const lines = content.split('\n');
            for(let line of lines) if(line.startsWith('--') && line.length > 10 && !line.includes(' ')) { boundary = line.trim(); break; }
        }
        if (!boundary) return { images: [] };

        const parts = content.split(boundary);
        const images = [];
        const minSizeBytes = config.minSizeKB * 1024;

        parts.forEach(part => {
            const headerEndIndex = part.search(/\r?\n\r?\n/);
            if (headerEndIndex !== -1) {
                const headers = part.substring(0, headerEndIndex);
                const body = part.substring(headerEndIndex); 
                const typeMatch = headers.match(/Content-Type:\s*image\/(jpeg|png|gif|webp)/i);
                const encMatch = headers.match(/Content-Transfer-Encoding:\s*base64/i);
                
                if (typeMatch && encMatch) {
                    const imgType = typeMatch[1].toLowerCase();
                    if (config.excludeGifs && imgType === 'gif') return;

                    const ext = imgType === 'jpeg' ? 'jpg' : imgType;
                    let loc = (headers.match(/Content-Location:\s*(.*)/i) || [])[1] || `img_${Math.random()}`;
                    try { loc = decodeURIComponent(loc.trim()); } catch(e){}
                    const originalName = loc.split('/').pop().split('?')[0]; 
                    const cleanBody = body.replace(/\s/g, '');
                    
                    if (cleanBody && cleanBody.length >= (minSizeBytes * 1.3)) {
                        try {
                            const binaryString = atob(cleanBody);
                            if (binaryString.length >= minSizeBytes) {
                                const bytes = new Uint8Array(binaryString.length);
                                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                                images.push({ name: originalName, data: bytes, ext });
                            }
                        } catch (e) {}
                    }
                }
            }
        });
        return { images };
    }

    function createZip(files) {
        const parts = []; const centralDirectory = []; let offset = 0; const textEnc = new TextEncoder();
        const crcTable = new Int32Array(256);
        for (let i=0; i<256; i++) { let c=i; for(let k=0; k<8; k++) c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1)); crcTable[i]=c; }
        const crc32 = (data) => { let crc=-1; for(let i=0; i<data.length; i++) crc=(crc>>>8)^crcTable[(crc^data[i])&0xFF]; return (crc^-1)>>>0; };
        
        files.forEach(file => {
            const nameBytes = textEnc.encode(file.zipName);
            const data = file.data; const crc = crc32(data);
            const header = new Uint8Array(30 + nameBytes.length); const v = new DataView(header.buffer);
            v.setUint32(0, 0x04034b50, true); v.setUint16(4, 10, true); v.setUint16(6, 0, true); v.setUint16(8, 0, true);
            v.setUint32(14, crc, true); v.setUint32(18, data.length, true); v.setUint32(22, data.length, true);
            v.setUint16(26, nameBytes.length, true); v.setUint16(28, 0, true); header.set(nameBytes, 30);
            parts.push(header); parts.push(data);
            const cd = new Uint8Array(46 + nameBytes.length); const cdv = new DataView(cd.buffer);
            cdv.setUint32(0, 0x02014b50, true); cdv.setUint16(4, 10, true); cdv.setUint16(6, 10, true);
            cdv.setUint16(8, 0, true); cdv.setUint16(10, 0, true); cdv.setUint32(16, crc, true);
            cdv.setUint32(20, data.length, true); cdv.setUint32(24, data.length, true); cdv.setUint16(28, nameBytes.length, true);
            cdv.setUint16(30, 0, true); cdv.setUint16(32, 0, true); cdv.setUint32(42, offset, true); cd.set(nameBytes, 46);
            centralDirectory.push(cd); offset += header.length + data.length;
        });
        const cdSize = centralDirectory.reduce((a, c) => a + c.length, 0);
        const eocd = new Uint8Array(22); const ev = new DataView(eocd.buffer);
        ev.setUint32(0, 0x06054b50, true); ev.setUint16(8, files.length, true);
        ev.setUint16(10, files.length, true); ev.setUint32(12, cdSize, true); ev.setUint32(16, offset, true);
        return new Blob([...parts, ...centralDirectory, eocd], {type: "application/zip"});
    }
</script>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const sizeSlider = document.getElementById('size-filter');
    const sizeVal = document.getElementById('size-val');
    const reverseCheck = document.getElementById('reverse-sort');
    const cbzCheck = document.getElementById('cbz-ext');
    const noGifsCheck = document.getElementById('no-gifs');
    
    const progressArea = document.getElementById('progress-area');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const percentText = document.getElementById('percent-text');
    
    const galleryArea = document.getElementById('gallery-area');
    const galleryGrid = document.getElementById('gallery-grid');
    const actionArea = document.getElementById('action-area');
    const resetBtn = document.getElementById('reset-btn');
    const downloadBtn = document.getElementById('download-btn');
    const themeBtn = document.getElementById('theme-toggle');
    const htmlEl = document.documentElement;
    
    let worker = null;
    let finalZipBlob = null;
    let finalFileName = "manga.zip";

    // PWA Install
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt = null;
        installBtn.classList.add('hidden');
    });

    function initWorker() {
        if (worker) worker.terminate();
        try {
            const blob = new Blob([document.querySelector('#worker-code').textContent], {type: "text/javascript"});
            worker = new Worker(window.URL.createObjectURL(blob));
            worker.onerror = () => { statusText.innerText = "Error: Worker blocked by browser."; statusText.style.color="red"; };
            worker.onmessage = function(e) {
                const d = e.data;
                if (d.type === 'progress') {
                    progressArea.style.display = 'block';
                    progressBar.style.width = d.percent + '%';
                    statusText.innerText = d.text;
                    percentText.innerText = Math.round(d.percent) + '%';
                } else if (d.type === 'done') {
                    progressBar.style.width = '100%'; percentText.innerText = '100%';
                    statusText.innerText = `Done: ${d.count} images`;
                    finalZipBlob = d.zipBlob;
                    finalFileName = d.suggestedName + (cbzCheck.checked ? ".cbz" : ".zip");
                    renderGallery(d.preview);
                    dropZone.classList.add('hidden');
                    galleryArea.style.display = 'block';
                    actionArea.style.display = 'flex';
                } else if (d.type === 'error') {
                    alert(d.message);
                    resetUI();
                }
            };
        } catch (e) { alert("Workers not supported"); }
    }
    
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = () => { if (fileInput.files.length) handleFiles(fileInput.files); };
    sizeSlider.oninput = (e) => sizeVal.innerText = e.target.value;
    
    downloadBtn.onclick = () => {
        if (!finalZipBlob) return;
        const url = URL.createObjectURL(finalZipBlob);
        const a = document.createElement('a');
        a.href = url; a.download = finalFileName;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };
    resetBtn.onclick = resetUI;

    themeBtn.onclick = () => {
        const next = htmlEl.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        htmlEl.setAttribute('data-theme', next);
        document.getElementById('moon-icon').classList.toggle('hidden');
        document.getElementById('sun-icon').classList.toggle('hidden');
    };

    function handleFiles(files) {
        if (!worker) initWorker();
        const config = { minSizeKB: parseInt(sizeSlider.value), reverse: reverseCheck.checked, excludeGifs: noGifsCheck.checked };
        dropZone.style.pointerEvents = "none";
        statusText.innerText = "Starting...";
        statusText.style.color = "var(--text-main)";
        progressArea.style.display = 'block';
        worker.postMessage({ files: Array.from(files), config });
    }

    function renderGallery(preview) {
        galleryGrid.innerHTML = '';
        preview.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gallery-item';
            div.innerHTML = `<img src="${URL.createObjectURL(item.blob)}">`;
            div.onclick = () => { 
                document.getElementById('img-modal').style.display = "flex"; 
                document.getElementById('modal-img').src = div.querySelector('img').src; 
            };
            galleryGrid.appendChild(div);
        });
    }

    function resetUI() {
        if (worker) worker.terminate();
        finalZipBlob = null; fileInput.value = '';
        progressArea.style.display = 'none'; galleryArea.style.display = 'none';
        actionArea.style.display = 'none'; dropZone.classList.remove('hidden');
        dropZone.style.pointerEvents = "auto"; progressBar.style.width = '0%';
        galleryGrid.innerHTML = '';
        initWorker();
    }
    
    // Close Modal
    document.querySelector('.modal-close').onclick = () => document.getElementById('img-modal').style.display = "none";
    document.getElementById('img-modal').onclick = (e) => { if(e.target === document.getElementById('img-modal')) e.target.style.display = "none"; };

    initWorker();
</script>
</body>
</html>

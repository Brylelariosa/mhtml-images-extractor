<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>Manga Tool Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; --panel: #f1f5f9; }
        [data-theme="dark"] { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; --panel: #1e293b; }
        
        body { margin:0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-selector { display: flex; background: var(--border); padding: 4px; border-radius: 8px; }
        .mode-btn { border: none; background: transparent; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: var(--text); font-weight: 500; }
        .mode-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Drop Zone */
        #drop-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; background: var(--card); margin-bottom: 20px; }
        #drop-zone:hover { border-color: var(--primary); background: rgba(79, 70, 229, 0.05); }

        /* Settings Panel */
        .settings-panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; display: none; }
        .settings-panel.active { display: block; }
        .setting-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9em; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Chapter List */
        .chapter { background: var(--card); margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .chap-head { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; background: var(--card); }
        .chap-head:hover { background: rgba(0,0,0,0.02); }
        .chap-content { display: none; padding: 15px; border-top: 1px solid var(--border); }
        .chap-content.open { display: block; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
        .grid img { width: 100%; border-radius: 4px; display: block; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn:disabled { opacity: 0.6; cursor: wait; }
        .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }

        #progress { margin-top: 10px; color: var(--primary); font-weight: 500; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h3>Manga Tool Ult.</h3>
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('extract')" id="mode-extract">Extractor</button>
            <button class="mode-btn" onclick="setMode('merge')" id="mode-merge">Merger</button>
        </div>
        <button class="btn secondary" id="theme-toggle" style="padding:6px 12px;">ðŸŒ™</button>
    </div>

    <div id="settings-extract" class="settings-panel active">
        <div class="setting-row">
            <strong>Extraction Settings:</strong>
            <span style="color:var(--text-sub); font-size:0.8em; margin-left: auto;">Auto-sorts by filename</span>
        </div>
        <div class="setting-row">
            <span>Keep original filenames</span>
            <label class="switch"><input type="checkbox" id="keep-names" checked><span class="slider"></span></label>
        </div>
    </div>

    <div id="settings-merge" class="settings-panel">
        <div class="setting-row">
            <strong>Merger Settings:</strong>
        </div>
        <div class="setting-row">
            <span>First Page is Cover (Single)</span>
            <label class="switch"><input type="checkbox" id="is-cover" onchange="renderAll()"><span class="slider"></span></label>
        </div>
        <div class="setting-row">
            <span>Shift Images (Add Blank First)</span>
            <button class="btn secondary" onclick="shiftImages()" style="padding: 2px 8px; font-size: 0.8em;">Apply Shift</button>
        </div>
    </div>

    <div id="drop-zone">
        <h3>Drag & Drop MHTML Files</h3>
        <p style="color:#64748b">or click to browse</p>
        <input type="file" id="file-input" multiple accept=".mhtml,.mht" style="display:none">
    </div>

    <div id="progress">Processing...</div>

    <div id="chapter-list"></div>

    <div class="btn-group" id="main-controls" style="display:none">
        <button class="btn" id="dl-all-btn">Download All (Zip)</button>
        <button class="btn secondary" id="reset-btn">Reset / Clear</button>
    </div>
</div>

<script>
    // State
    let worker;
    let rawGroups = [];
    let currentMode = 'extract'; // 'extract' or 'merge'
    let processingQueue = [];
    let processedCount = 0;

    // Elements
    const els = {
        drop: document.getElementById('drop-zone'),
        input: document.getElementById('file-input'),
        list: document.getElementById('chapter-list'),
        progress: document.getElementById('progress'),
        controls: document.getElementById('main-controls'),
        dlBtn: document.getElementById('dl-all-btn'),
        themeBtn: document.getElementById('theme-toggle')
    };

    function init() {
        // Init Worker
        worker = new Worker('worker.js');
        worker.onmessage = handleWorkerMsg;
        
        // Service Worker
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

        // Theme
        if(localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        // Event Listeners
        els.drop.onclick = () => els.input.click();
        els.drop.ondragover = e => { e.preventDefault(); els.drop.style.borderColor = 'var(--primary)'; };
        els.drop.ondragleave = () => els.drop.style.borderColor = 'var(--border)';
        els.drop.ondrop = e => {
            e.preventDefault();
            els.drop.style.borderColor = 'var(--border)';
            handleFiles(e.dataTransfer.files);
        };
        els.input.onchange = e => handleFiles(e.target.files);
        
        els.themeBtn.onclick = () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        els.dlBtn.onclick = () => {
            if(!rawGroups.length) return;
            setBtnState(true, 'Zipping...');
            worker.postMessage({ type: 'zip', groups: rawGroups });
        };

        document.getElementById('reset-btn').onclick = () => location.reload();
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-extract').className = `mode-btn ${mode === 'extract' ? 'active' : ''}`;
        document.getElementById('mode-merge').className = `mode-btn ${mode === 'merge' ? 'active' : ''}`;
        document.getElementById('settings-extract').classList.toggle('active', mode === 'extract');
        document.getElementById('settings-merge').classList.toggle('active', mode === 'merge');
        renderAll();
    }

    async function handleFiles(files) {
        if(!files.length) return;
        els.drop.style.display = 'none';
        els.progress.style.display = 'block';

        // Sort files strictly by number (Chapter 1, 2, 10)
        processingQueue = Array.from(files).sort((a, b) => 
            a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' })
        );

        processedCount = 0;
        processNext();
    }

    function processNext() {
        if (processedCount >= processingQueue.length) {
            els.progress.style.display = 'none';
            els.controls.style.display = 'flex';
            renderAll();
            return;
        }

        const file = processingQueue[processedCount];
        els.progress.innerText = `Processing ${processedCount + 1}/${processingQueue.length}: ${file.name}`;
        worker.postMessage({ type: 'extractOne', file: file, fileId: processedCount });
    }

    function handleWorkerMsg(e) {
        const { type, groupName, images, blob, filename } = e.data;
        if (type === 'done') {
            rawGroups.push({ groupName, images });
            processedCount++;
            processNext();
        } 
        else if (type === 'zipDone') {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            setBtnState(false, 'Download All (Zip)');
        }
        else if (type === 'error') {
            console.error(e.data.message);
            processedCount++;
            processNext();
        }
    }

    // --- Rendering Logic ---
    function renderAll() {
        els.list.innerHTML = '';
        rawGroups.sort((a,b) => a.groupName.localeCompare(b.groupName, undefined, {numeric:true}));
        rawGroups.forEach(group => renderChapter(group));
    }

    function renderChapter(group) {
        const div = document.createElement('div');
        div.className = 'chapter';
        
        const head = document.createElement('div');
        head.className = 'chap-head';
        head.innerHTML = `<span><b>${group.groupName}</b> <small>(${group.images.length} pages)</small></span>`;
        
        // Single Download Icon
        const dlIcon = document.createElement('button');
        dlIcon.innerText = 'â¬‡ï¸';
        dlIcon.style.cssText = "background:none; border:none; cursor:pointer;";
        dlIcon.title = "Download this chapter";
        dlIcon.onclick = (e) => {
            e.stopPropagation();
            setBtnState(true, 'Zipping Chapter...');
            worker.postMessage({ type: 'zip', groups: [group] });
        };
        head.appendChild(dlIcon);

        const content = document.createElement('div');
        content.className = 'chap-content';

        head.onclick = (e) => {
            if(e.target === dlIcon) return;
            content.classList.toggle('open');
            if(content.classList.contains('open') && !content.hasChildNodes()) {
                if(currentMode === 'merge') renderMergeMode(content, group);
                else renderExtractMode(content, group);
            }
        };

        div.appendChild(head);
        div.appendChild(content);
        els.list.appendChild(div);
    }

    function renderExtractMode(container, group) {
        const grid = document.createElement('div');
        grid.className = 'grid';
        group.images.forEach(img => {
            const el = document.createElement('img');
            const blob = new Blob([img.data]);
            el.src = URL.createObjectURL(blob);
            grid.appendChild(el);
        });
        container.appendChild(grid);
    }

    function renderMergeMode(container, group) {
        const grid = document.createElement('div');
        grid.className = 'grid';
        // Make grid 2-col for preview
        grid.style.gridTemplateColumns = "repeat(auto-fit, minmax(200px, 1fr))";

        const isCover = document.getElementById('is-cover').checked;
        let i = 0;

        if(isCover && group.images.length > 0) {
             const img = document.createElement('img');
             img.src = URL.createObjectURL(new Blob([group.images[0].data]));
             img.style.gridColumn = "1 / -1"; // Full width
             img.style.width = "50%";
             img.style.margin = "0 auto";
             grid.appendChild(img);
             i = 1;
        }

        while(i < group.images.length) {
            const wrap = document.createElement('div');
            wrap.style.display = 'flex';
            wrap.style.border = '1px solid #ddd';
            
            // Left Image (Next in array)
            if(i < group.images.length) {
                const imgL = document.createElement('img');
                imgL.src = URL.createObjectURL(new Blob([group.images[i].data]));
                imgL.style.width = "50%";
                wrap.appendChild(imgL);
            }
            // Right Image
            if(i+1 < group.images.length) {
                const imgR = document.createElement('img');
                imgR.src = URL.createObjectURL(new Blob([group.images[i+1].data]));
                imgR.style.width = "50%";
                wrap.appendChild(imgR);
            }
            grid.appendChild(wrap);
            i += 2;
        }
        container.appendChild(grid);
    }

    // --- Helper Features ---
    window.shiftImages = async function() {
        if(rawGroups.length === 0) return;
        // 1x1 Transparent Pixel
        const whitePixel = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";
        const res = await fetch("data:image/png;base64," + whitePixel);
        const u8 = new Uint8Array(await res.arrayBuffer());
        
        // Add to first group
        rawGroups[0].images.unshift({ name: "0000_shift.png", data: u8 });
        alert("Shifted! A blank page was added to the start.");
        renderAll();
    };

    function setBtnState(disabled, text) {
        els.dlBtn.disabled = disabled;
        const old = els.dlBtn.innerText;
        els.dlBtn.innerText = text;
        if(!disabled) setTimeout(() => els.dlBtn.innerText = 'Download All (Zip)', 2000);
    }

    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Manga Extractor & Merger Tool">
    <title>Manga Tool Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #4f46e5; --bg-color: #f8fafc; --card-bg: #ffffff; --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0; --panel-bg: #f1f5f9; --drop-bg: #f8fafc; --drop-border: #cbd5e1; --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        [data-theme="dark"] { --primary: #6366f1; --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-sub: #94a3b8; --border: #334155; --panel-bg: #1e293b; --drop-bg: #0f172a; --drop-border: #475569; }
        
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-main); transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Header & Toggle */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .title-group h1 { font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--text-main); }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.25rem; padding: 8px; border-radius: 50%; color: var(--text-main); }
        .icon-btn:hover { background-color: var(--panel-bg); }

        /* Mode Selector */
        .mode-switch { display: flex; background: var(--panel-bg); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: none; border-radius: 8px; font-weight: 600; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
        .mode-btn.active { background: var(--card-bg); color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Settings Panels */
        .panel { display: none; background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        .panel.active { display: block; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .setting-label { font-size: 0.9rem; font-weight: 500; }
        
        /* Drop Zone */
        .drop-zone { border: 2px dashed var(--drop-border); border-radius: 16px; padding: 40px 20px; text-align: center; background: var(--drop-bg); cursor: pointer; transition: 0.2s; margin-bottom: 20px; }
        .drop-zone:hover { border-color: var(--primary); background: var(--panel-bg); }
        .drop-icon { font-size: 2.5rem; margin-bottom: 12px; display: block; }

        /* Chapter List */
        .chapter-list { display: flex; flex-direction: column; gap: 12px; }
        .chapter-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .chapter-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .chapter-header:hover { background: var(--panel-bg); }
        
        .gallery { display: none; padding: 16px; border-top: 1px solid var(--border); grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .gallery.open { display: grid; }
        .gallery img { width: 100%; height: auto; border-radius: 6px; object-fit: cover; }

        /* Buttons */
        .action-bar { display: none; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn:disabled { opacity: 0.7; cursor: wait; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title-group">
            <h1>Manga Tool Ult.</h1>
        </div>
        <button class="icon-btn" id="theme-toggle">ðŸŒ™</button>
    </div>

    <div class="mode-switch">
        <button class="mode-btn active" onclick="switchMode('extractor')" id="tab-extract">Extractor</button>
        <button class="mode-btn" onclick="switchMode('merger')" id="tab-merge">Merger</button>
    </div>

    <div id="panel-extractor" class="panel active">
        <div class="setting-row">
            <span class="setting-label">Sort files by name</span>
            <label class="switch"><input type="checkbox" checked disabled><span class="slider"></span></label>
        </div>
        <div class="setting-row">
            <span class="setting-label">Keep original filenames</span>
            <label class="switch"><input type="checkbox" id="keep-names" checked><span class="slider"></span></label>
        </div>
    </div>

    <div id="panel-merger" class="panel">
        <div class="setting-row">
            <span class="setting-label">Shift Images (Add Blank Page)</span>
            <button class="btn-secondary" onclick="shiftImages()" style="padding: 6px 12px; border-radius:6px;">Apply Shift</button>
        </div>
        <div class="setting-row">
            <span class="setting-label">Visual Merge (Preview)</span>
            <label class="switch"><input type="checkbox" id="visual-merge" onchange="renderAll()"><span class="slider"></span></label>
        </div>
    </div>

    <div class="drop-zone" id="drop-zone">
        <span class="drop-icon">ðŸ“‚</span>
        <div style="font-weight:600; font-size:1.1rem">Tap or Drop Files</div>
        <div style="color:var(--text-sub); margin-top:4px">Supports .mhtml, .mht</div>
        <input type="file" id="file-input" multiple accept=".mhtml,.mht" style="display:none">
    </div>

    <div id="progress-text" style="text-align:center; color:var(--primary); font-weight:600; display:none; margin: 15px 0;">
        Processing...
    </div>

    <div class="chapter-list" id="chapter-list"></div>

    <div class="action-bar" id="action-bar">
        <button class="btn btn-secondary" id="reset-btn">Reset</button>
        <button class="btn btn-primary" id="download-btn">Download All (Zip)</button>
    </div>
</div>

<script>
    // --- STATE ---
    let worker;
    let rawGroups = []; // Stores { groupName, images: [{name, data}] }
    let processingQueue = [];
    let processedCount = 0;
    let activeUrls = []; // For cleanup

    // --- ELEMENTS ---
    const els = {
        drop: document.getElementById('drop-zone'),
        input: document.getElementById('file-input'),
        list: document.getElementById('chapter-list'),
        progress: document.getElementById('progress-text'),
        actionBar: document.getElementById('action-bar'),
        dlBtn: document.getElementById('download-btn'),
        themeBtn: document.getElementById('theme-toggle')
    };

    // --- INIT ---
    function init() {
        // Load the external worker
        worker = new Worker('worker.js');
        worker.onmessage = handleWorkerMessage;
        
        // Service Worker for Offline
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

        // Theme Logic
        if(localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        // Event Listeners
        els.drop.onclick = () => els.input.click();
        els.drop.ondragover = e => { e.preventDefault(); els.drop.style.borderColor = 'var(--primary)'; };
        els.drop.ondragleave = () => els.drop.style.borderColor = 'var(--drop-border)';
        els.drop.ondrop = e => {
            e.preventDefault();
            els.drop.style.borderColor = 'var(--drop-border)';
            handleFiles(e.dataTransfer.files);
        };
        els.input.onchange = e => handleFiles(e.target.files);

        els.dlBtn.onclick = () => {
            if(!rawGroups.length) return;
            setBtnLoading(true, 'Zipping...');
            worker.postMessage({ type: 'zip', groups: rawGroups });
        };

        document.getElementById('reset-btn').onclick = () => {
             // Cleanup memory before reload
             activeUrls.forEach(u => URL.revokeObjectURL(u));
             location.reload();
        };
        
        els.themeBtn.onclick = () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const newT = isDark ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newT);
            localStorage.setItem('theme', newT);
        };
    }

    // --- UI LOGIC ---
    window.switchMode = function(mode) {
        document.getElementById('tab-extract').className = `mode-btn ${mode==='extractor'?'active':''}`;
        document.getElementById('tab-merge').className = `mode-btn ${mode==='merger'?'active':''}`;
        document.getElementById('panel-extractor').className = `panel ${mode==='extractor'?'active':''}`;
        document.getElementById('panel-merger').className = `panel ${mode==='merger'?'active':''}`;
        renderAll();
    };

    // --- FILE HANDLING ---
    async function handleFiles(files) {
        if(!files.length) return;
        els.drop.style.display = 'none';
        els.progress.style.display = 'block';

        // Sort files naturally
        processingQueue = Array.from(files).sort((a, b) => 
            a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' })
        );

        processedCount = 0;
        processNext();
    }

    function processNext() {
        if (processedCount >= processingQueue.length) {
            els.progress.style.display = 'none';
            els.actionBar.style.display = 'flex';
            renderAll();
            return;
        }

        const file = processingQueue[processedCount];
        els.progress.innerText = `Extracting ${processedCount + 1}/${processingQueue.length}: ${file.name}`;
        
        // Send to new worker
        worker.postMessage({ type: 'extract', file: file, fileId: processedCount });
    }

    function handleWorkerMessage(e) {
        const { type, groupName, images, blob, name } = e.data;

        if (type === 'done') {
            rawGroups.push({ groupName, images });
            processedCount++;
            processNext();
        } 
        else if (type === 'zipDone') {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
            setBtnLoading(false, 'Download All (Zip)');
        }
        else if (type === 'error') {
            console.error(e.data.message);
            processedCount++;
            processNext();
        }
    }

    // --- RENDERING ---
    window.renderAll = function() {
        els.list.innerHTML = '';
        activeUrls.forEach(u => URL.revokeObjectURL(u)); // Clean old URLs
        activeUrls = [];

        // Sort groups by name
        rawGroups.sort((a,b) => a.groupName.localeCompare(b.groupName, undefined, {numeric:true}));

        rawGroups.forEach(group => {
            const card = document.createElement('div');
            card.className = 'chapter-card';
            
            const head = document.createElement('div');
            head.className = 'chapter-header';
            head.innerHTML = `<div><b>${group.groupName}</b> <span style="color:var(--text-sub); font-size:0.9em">(${group.images.length} pages)</span></div> <span>â–¼</span>`;
            
            const gallery = document.createElement('div');
            gallery.className = 'gallery';
            
            // Populate images
            const isVisualMerge = document.getElementById('visual-merge').checked;
            
            if (isVisualMerge) {
                // Merge view (side by side in 2 columns)
                gallery.style.gridTemplateColumns = "repeat(auto-fit, minmax(250px, 1fr))";
                for(let i=0; i<group.images.length; i+=2) {
                    const wrap = document.createElement('div');
                    wrap.style.display = 'flex';
                    wrap.style.border = '1px solid var(--border)';
                    
                    if(group.images[i]) appendImg(wrap, group.images[i], "50%");
                    if(group.images[i+1]) appendImg(wrap, group.images[i+1], "50%");
                    
                    gallery.appendChild(wrap);
                }
            } else {
                // Normal view
                gallery.style.gridTemplateColumns = "repeat(auto-fill, minmax(100px, 1fr))";
                group.images.forEach(img => appendImg(gallery, img, "100%"));
            }

            // Accordion Logic
            head.onclick = () => {
                const isOpen = gallery.classList.contains('open');
                gallery.classList.toggle('open');
                head.lastElementChild.innerText = isOpen ? 'â–¼' : 'â–²';
            };

            card.appendChild(head);
            card.appendChild(gallery);
            els.list.appendChild(card);
        });
    };

    function appendImg(container, imgObj, width) {
        const blob = new Blob([imgObj.data]);
        const url = URL.createObjectURL(blob);
        activeUrls.push(url);
        
        const img = document.createElement('img');
        img.src = url;
        img.loading = "lazy";
        img.style.width = width;
        container.appendChild(img);
    }

    function setBtnLoading(isLoading, text) {
        els.dlBtn.disabled = isLoading;
        els.dlBtn.innerText = text;
    }

    // --- YOUR CUSTOM SHIFT FUNCTION ---
    window.shiftImages = async function() {
        if(rawGroups.length === 0) return;
        
        // 1x1 Transparent Pixel (Base64)
        const whitePixel = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";
        const res = await fetch("data:image/png;base64," + whitePixel);
        const u8 = new Uint8Array(await res.arrayBuffer());
        
        // Add to the FIRST group found (usually Chapter 1)
        rawGroups[0].images.unshift({ name: "0000_shifted.png", data: u8 });
        
        alert("Shifted! Added blank page to the start.");
        renderAll();
    };

    init();
</script>
</body>
</html>
